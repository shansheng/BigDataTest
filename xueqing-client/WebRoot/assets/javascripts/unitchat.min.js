var rt,room,firstFlag=!0,logFlag=!1,sendBtn=document.getElementById("send-btn"),inputName=document.getElementById("input-name"),inputSend=document.getElementById("input-send"),printWall=document.getElementById("print-wall"),msgTime;bindEvent(sendBtn,"click",sendMsg);bindEvent(document.body,"keydown",function(b){13===b.keyCode&&(firstFlag?main():sendMsg())});function main(){firstFlag||rt.close();rt=AV.realtime({appId:appId,clientId:clientId,secure:!1});rt.on("open",function(){firstFlag=!1;rt.room(roomId,function(b){b?(room=b,room.join(function(){room.list(function(a){rt.ping(a.slice(0,20),function(a){});490<a.length&&room.remove(a[30],function(){showLog("\u4eba\u6570\u8fc7\u591a\uff0c\u8e22\u6389\uff1a ",a[30])});getLog(function(){printWall.scrollTop=printWall.scrollHeight;showLog("\u5df2\u7ecf\u52a0\u5165\uff0c\u53ef\u4ee5\u5f00\u59cb\u804a\u5929\u3002")})})}),room.receive(function(a){msgTime||(msgTime=a.timestamp);showMsg(a)})):(showLog("\x3cfont color\x3dred\x3e\u670d\u52a1\u5668\u4e0d\u5b58\u5728\u8fd9\u4e2a\u623f\u95f4\uff0c\u65e0\u6cd5\u4e92\u52a8\u804a\u5929\uff0c\u8bf7\u8054\u7cfb\u7ba1\u7406\u5458\u3002\x3c/font\x3e"),rt.room({name:"LeanCloud-Room",members:[clientId],attr:{test:"demo2"}},function(a){room=a;roomId=room.id;rt.close();main()}))})});rt.on("reuse",function(){showLog("\u670d\u52a1\u5668\u6b63\u5728\u91cd\u8fde\uff0c\u8bf7\u8010\u5fc3\u7b49\u5f85\u3002\u3002\u3002")});rt.on("error",function(){showLog("\u8fde\u63a5\u9047\u5230\u9519\u8bef\u3002\u3002\u3002")})}function sendMsg(){if(firstFlag)alert("\u8bf7\u5148\u8fde\u63a5\u670d\u52a1\u5668\uff01");else{var b=inputSend.value;String(b).replace(/^\s+/,"").replace(/\s+$/,"")?room.send({text:b},{type:"text"},function(a){inputSend.value="";showLog(formatTime(a.t)+"_\u81ea\u5df1\uff1a ",b);printWall.scrollTop=printWall.scrollHeight}):alert("\u8bf7\u8f93\u5165\u70b9\u6587\u5b57\uff01")}}function showMsg(b,a){var c="",d=b.fromPeerId,c=b.msg.type?b.msg.text:b.msg;b.fromPeerId===clientId&&(d="\u81ea\u5df1");String(c).replace(/^\s+/,"").replace(/\s+$/,"")&&showLog(""+formatTime(b.timestamp)+"_"+encodeHTML(d)+"\uff1a ",c,a)}bindEvent(printWall,"scroll",function(b){20>printWall.scrollTop&&getLog()});function getLog(b){var a=printWall.scrollHeight;logFlag||(logFlag=!0,room.log({t:msgTime},function(c){logFlag=!1;var d=c.length;d&&(msgTime=c[0].timestamp);for(var e=d-1;0<=e;e--)showMsg(c[e],!0);d&&(printWall.scrollTop=printWall.scrollHeight-a);b&&b()}))}function showLog(b,a,c){a&&(b=b.split("_"),b="\x3cdiv class\x3d'avatar' \x3e         \x3cimg alt\x3d'Avatar' src\x3d'/assets/images/avatar.jpg' height\x3d'23' width\x3d'23'\x3e       \x3c/div\x3e       \x3cdiv class\x3d'name-and-time' style\x3d'margin-left: 33px; overflow: hidden;margin-top: -18px;'\x3e        \x3cdiv class\x3d'name pull-left'\x3e         \x3csmall\x3e           \x3ca class\x3d'text-contrast' href\x3d'#'\x3e"+b[1]+"\x3c/a\x3e         \x3c/small\x3e       \x3c/div\x3e       \x3cdiv class\x3d'time pull-right'\x3e         \x3csmall class\x3d'date pull-right text-muted'\x3e            \x3cspan class\x3d'timeago fade has-tooltip in' data-placement\x3d'top' title\x3d''\x3e"+b[0]+"\x3c/span\x3e             \x3ci class\x3d'icon-time'\x3e\x3c/i\x3e                \x3c/small\x3e          \x3c/div\x3e            \x3c/div\x3e         \x3cdiv class\x3d'body' style\x3d'margin-left: 33px;'\x3e"+encodeHTML(JSON.stringify(a))+"          \x3c/div\x3e                  ");a=document.createElement("li");a.setAttribute("class","message");a.setAttribute("style","border-bottom: 1px solid #dddddd;padding: 10px;position: relative;overflow: hidden;");a.innerHTML=b;c?printWall.insertBefore(a,printWall.childNodes[0]):printWall.appendChild(a)}function encodeHTML(b){return String(b).replace(/&/g,"\x26amp;").replace(/</g,"\x26lt;").replace(/>/g,"\x26gt;")}function formatTime(b){var a=new Date(b);a.getMonth();a.getMonth();a.getDate();a.getDate();b=10>a.getHours()?"0"+a.getHours():a.getHours();var c=10>a.getMinutes()?"0"+a.getMinutes():a.getMinutes(),a=10>a.getSeconds()?"0"+a.getSeconds():a.getSeconds();return b+":"+c+":"+a}function bindEvent(b,a,c){window.addEventListener?b.addEventListener(a,c):b.attachEvent("on"+a,c)};